(function(){"use strict";const A=(e,t)=>t.some(n=>e instanceof n);let T,L;function N(){return T||(T=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function U(){return L||(L=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const B=new WeakMap,E=new WeakMap,b=new WeakMap;function k(e){const t=new Promise((n,r)=>{const o=()=>{e.removeEventListener("success",a),e.removeEventListener("error",s)},a=()=>{n(f(e.result)),o()},s=()=>{r(e.error),o()};e.addEventListener("success",a),e.addEventListener("error",s)});return b.set(t,e),t}function $(e){if(B.has(e))return;const t=new Promise((n,r)=>{const o=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",s),e.removeEventListener("abort",s)},a=()=>{n(),o()},s=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",a),e.addEventListener("error",s),e.addEventListener("abort",s)});B.set(e,t)}let M={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return B.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function F(e){M=e(M)}function H(e){return U().includes(e)?function(...t){return e.apply(S(this),t),f(this.request)}:function(...t){return f(e.apply(S(this),t))}}function G(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&$(e),A(e,N())?new Proxy(e,M):e)}function f(e){if(e instanceof IDBRequest)return k(e);if(E.has(e))return E.get(e);const t=G(e);return t!==e&&(E.set(e,t),b.set(t,e)),t}const S=e=>b.get(e);function J(e,t,{blocked:n,upgrade:r,blocking:o,terminated:a}={}){const s=indexedDB.open(e,t),u=f(s);return r&&s.addEventListener("upgradeneeded",c=>{r(f(s.result),c.oldVersion,c.newVersion,f(s.transaction),c)}),n&&s.addEventListener("blocked",c=>n(c.oldVersion,c.newVersion,c)),u.then(c=>{a&&c.addEventListener("close",()=>a()),o&&c.addEventListener("versionchange",i=>o(i.oldVersion,i.newVersion,i))}).catch(()=>{}),u}const z=["get","getKey","getAll","getAllKeys","count"],X=["put","add","delete","clear"],C=new Map;function j(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(C.get(t))return C.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=X.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(o||z.includes(n)))return;const a=async function(s,...u){const c=this.transaction(s,o?"readwrite":"readonly");let i=c.store;return r&&(i=i.index(u.shift())),(await Promise.all([i[n](...u),o&&c.done]))[0]};return C.set(t,a),a}F(e=>({...e,get:(t,n,r)=>j(t,n)||e.get(t,n,r),has:(t,n)=>!!j(t,n)||e.has(t,n)}));const Z=["continue","continuePrimaryKey","advance"],R={},x=new WeakMap,W=new WeakMap,Q={get(e,t){if(!Z.includes(t))return e[t];let n=R[t];return n||(n=R[t]=function(...r){x.set(this,W.get(this)[t](...r))}),n}};async function*Y(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,Q);for(W.set(n,t),b.set(n,S(t));t;)yield n,t=await(x.get(n)||t.continue()),x.delete(n)}function _(e,t){return t===Symbol.asyncIterator&&A(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&A(e,[IDBIndex,IDBObjectStore])}F(e=>({...e,get(t,n,r){return _(t,n)?Y:e.get(t,n,r)},has(t,n){return _(t,n)||e.has(t,n)}}));async function O(e,t){const n=await crypto.subtle.exportKey("raw",e),r=await crypto.subtle.importKey("raw",n,"HKDF",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:t,info:new TextEncoder().encode("RecordEncryption")},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function q(e,t){const n=crypto.getRandomValues(new Uint8Array(12)),r=crypto.getRandomValues(new Uint8Array(16)),o=await O(t,r),a=new TextEncoder,s=await crypto.subtle.encrypt({name:"AES-GCM",iv:n},o,a.encode(e)),u=new Uint8Array(s),c=u.slice(0,-16),i=u.slice(-16),h={version:2,encrypted:(l=>{let w="";const d=l.byteLength,p=32768;for(let g=0;g<d;g+=p){const K=l.subarray(g,Math.min(g+p,d));w+=String.fromCharCode.apply(null,Array.from(K))}return btoa(w)})(c),iv:btoa(String.fromCharCode(...n)),tag:btoa(String.fromCharCode(...i)),salt:btoa(String.fromCharCode(...r))};return JSON.stringify(h)}async function ee(e,t){const n=JSON.parse(e);if(n.version!==2)throw new Error(`Unsupported encryption version: ${n.version}. Migration required.`);const r=m=>{const h=atob(m),l=h.length,w=new Uint8Array(l);for(let d=0;d<l;d++)w[d]=h.charCodeAt(d);return w},o=r(n.iv),a=r(n.encrypted),s=r(n.tag),u=n.salt?r(n.salt):new Uint8Array(0);if(u.length!==16)throw new Error("Invalid or missing salt in V2.2 record");const c=await O(t,u),i=new Uint8Array(a.length+s.length);i.set(a,0),i.set(s,a.length);try{const m=await crypto.subtle.decrypt({name:"AES-GCM",iv:o},c,i);return new TextDecoder().decode(m)}catch{throw new Error("Decryption failed")}}const D=self;let v=null;const te="nahan",ne=4,re="idx_",oe=(e,t="image/png")=>{const n=atob(e.split(",")[1]||e),r=new Uint8Array(n.length);for(let o=0;o<n.length;o++)r[o]=n.charCodeAt(o);return new Blob([r],{type:t})},V=async()=>(v||(v=await J(te,ne)),v),se=async(e,t)=>{const n=await crypto.subtle.exportKey("raw",t),r=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),o=await crypto.subtle.sign("HMAC",r,new TextEncoder().encode(e));return Array.from(new Uint8Array(o)).map(a=>a.toString(16).padStart(2,"0")).join("")},ae=async e=>{const t=performance.now(),{fingerprint:n,limit:r,offset:o,masterKey:a}=e,s=await V(),u=await se(n,a),c=`${re}${u}_`,i=IDBKeyRange.bound(c,c+"ï¿¿",!1,!1),h=s.transaction("secure_vault","readonly").objectStore("secure_vault"),l=[],w=performance.now();let d=await h.openCursor(i,"prev");o>0&&d&&await d.advance(o);let p=0;for(;d&&l.length<r;)p++,d.value.id.startsWith(c)&&l.push(d.value),d=await d.continue();const g=performance.now()-w,K=performance.now(),ie=await Promise.all(l.map(async P=>{try{const I=await ee(P.payload,a),y=JSON.parse(I);if(y.content&&y.content.image&&y.content.image.startsWith("data:")&&(y.content.imageBlob=oe(y.content.image),delete y.content.image),y.recipientFingerprint===n||y.senderFingerprint===n)return y.createdAt&&(y.createdAt=new Date(y.createdAt)),y}catch{}return null})),de=performance.now()-K;return console.log(`[PERF][Worker] getMessages('${n}') - Scan: ${g.toFixed(2)}ms (${p} items), Decrypt: ${de.toFixed(2)}ms, Total: ${(performance.now()-t).toFixed(2)}ms`),ie.filter(Boolean).sort((P,I)=>I.createdAt.getTime()-P.createdAt.getTime())},ce=async e=>{const{message:t,masterKey:n}=e,r=await V(),o=await q(JSON.stringify(t),n),a={id:t.id,payload:o},s=r.transaction("secure_vault","readwrite");return await s.objectStore("secure_vault").put(a),await s.done,t};D.onmessage=async e=>{const{id:t,type:n,payload:r}=e.data;try{if(n==="getMessages"){const o=await ae(r);D.postMessage({id:t,success:!0,data:o})}else if(n==="storeMessage"){const o=await ce(r);D.postMessage({id:t,success:!0,data:o})}}catch(o){D.postMessage({id:t,success:!1,error:o.message})}}})();
