{"version":3,"file":"auth.worker-BVFK7z2M.js","sources":["../src/workers/auth.worker.ts"],"sourcesContent":["\nconst ctx: Worker = self as unknown as Worker;\n\ninterface AuthWorkerRequest {\n  id: string;\n  type: 'deriveWrapperKey';\n  payload: {\n    pin: string;\n    hardwareSecret: Uint8Array;\n    salt: Uint8Array;\n  };\n}\n\nconst handleDeriveWrapperKey = async (payload: AuthWorkerRequest['payload']): Promise<JsonWebKey> => {\n  const { pin, hardwareSecret, salt } = payload;\n  const encoder = new TextEncoder();\n  const pinBuffer = encoder.encode(pin);\n\n  // Combine PIN and Hardware Secret\n  const combinedMaterial = new Uint8Array(pinBuffer.length + hardwareSecret.length);\n  combinedMaterial.set(pinBuffer, 0);\n  combinedMaterial.set(hardwareSecret, pinBuffer.length);\n\n  const baseKey = await crypto.subtle.importKey(\n    'raw',\n    combinedMaterial,\n    'PBKDF2',\n    false,\n    ['deriveKey']\n  );\n\n  const derivedKey = await crypto.subtle.deriveKey(\n    {\n      name: 'PBKDF2',\n      salt: salt,\n      iterations: 100000,\n      hash: 'SHA-256',\n    },\n    baseKey,\n    { name: 'AES-KW', length: 256 }, // AES-KW for wrapping\n    true, // Extractable so we can export back to main thread\n    ['wrapKey', 'unwrapKey']\n  );\n\n  // Export as JWK to transfer back to main thread (CryptoKey is not transferable in all browsers yet, but structured clone supports it in modern ones)\n  // Actually, CryptoKey IS structured cloneable in modern browsers. Let's try returning it directly or exporting.\n  // Ideally return CryptoKey if supported. If not, JWK.\n  // React/Vite env usually supports it.\n  // But to be safe and simple, let's export to JWK.\n  return await crypto.subtle.exportKey('jwk', derivedKey);\n};\n\nctx.onmessage = async (event: MessageEvent) => {\n  const { id, type, payload } = event.data as AuthWorkerRequest;\n\n  try {\n    if (type === 'deriveWrapperKey') {\n      const result = await handleDeriveWrapperKey(payload);\n      ctx.postMessage({ id, success: true, data: result });\n    }\n  } catch (error) {\n    ctx.postMessage({ id, success: false, error: (error as Error).message });\n  }\n};\n\nexport { };\n\n"],"names":["ctx","handleDeriveWrapperKey","payload","pin","hardwareSecret","salt","pinBuffer","combinedMaterial","baseKey","derivedKey","event","id","type","result","error"],"mappings":"yBACA,MAAMA,EAAc,KAYdC,EAAyB,MAAOC,GAA+D,CACnG,KAAM,CAAE,IAAAC,EAAK,eAAAC,EAAgB,KAAAC,CAAA,EAASH,EAEhCI,EADU,IAAI,YAAA,EACM,OAAOH,CAAG,EAG9BI,EAAmB,IAAI,WAAWD,EAAU,OAASF,EAAe,MAAM,EAChFG,EAAiB,IAAID,EAAW,CAAC,EACjCC,EAAiB,IAAIH,EAAgBE,EAAU,MAAM,EAErD,MAAME,EAAU,MAAM,OAAO,OAAO,UAClC,MACAD,EACA,SACA,GACA,CAAC,WAAW,CAAA,EAGRE,EAAa,MAAM,OAAO,OAAO,UACrC,CACE,KAAM,SACN,KAAAJ,EACA,WAAY,IACZ,KAAM,SAAA,EAERG,EACA,CAAE,KAAM,SAAU,OAAQ,GAAA,EAC1B,GACA,CAAC,UAAW,WAAW,CAAA,EAQzB,OAAO,MAAM,OAAO,OAAO,UAAU,MAAOC,CAAU,CACxD,EAEAT,EAAI,UAAY,MAAOU,GAAwB,CAC7C,KAAM,CAAE,GAAAC,EAAI,KAAAC,EAAM,QAAAV,CAAA,EAAYQ,EAAM,KAEpC,GAAI,CACF,GAAIE,IAAS,mBAAoB,CAC/B,MAAMC,EAAS,MAAMZ,EAAuBC,CAAO,EACnDF,EAAI,YAAY,CAAE,GAAAW,EAAI,QAAS,GAAM,KAAME,EAAQ,CACrD,CACF,OAASC,EAAO,CACdd,EAAI,YAAY,CAAE,GAAAW,EAAI,QAAS,GAAO,MAAQG,EAAgB,QAAS,CACzE,CACF"}